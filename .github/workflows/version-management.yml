name: Version Management

# Trigger: PR merged to main branch
on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  auto-version:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required for pushing commits and tags
      pull-requests: read

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 1: Checkout repository
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit analysis
          token: ${{ secrets.GITHUB_TOKEN }}

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 2: Configure Git
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 3: Install dependencies
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 4: Get current version
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Get current version
        id: current_version
        run: |
          if [ -f .claude/.version ]; then
            VERSION=$(cat .claude/.version)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Current version: $VERSION"
          else
            echo "ERROR: .claude/.version not found" >&2
            exit 1
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 5: Analyze commits for version bump type
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Analyze commits
        id: analyze
        run: |
          # Get commits from this PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Analyzing commits from $BASE_SHA to $HEAD_SHA"

          # Get commit messages (subject + body)
          COMMITS=$(git log --format="%s|%b" $BASE_SHA..$HEAD_SHA)

          # Analyze commits to determine bump type
          BUMP_TYPE=$(bash .claude/lib/version/analyze-commits.sh "$COMMITS")

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Bump type: $BUMP_TYPE"

          # Export for next steps
          echo "BUMP_TYPE=$BUMP_TYPE" >> $GITHUB_ENV

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 6: Calculate new version
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Calculate new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          BUMP_TYPE="${{ steps.analyze.outputs.bump_type }}"

          echo "Current: $CURRENT_VERSION, Bump: $BUMP_TYPE"

          # Calculate new version
          NEW_VERSION=$(bash .claude/lib/version/bump-version.sh "$CURRENT_VERSION" "$BUMP_TYPE")

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

          # Export for next steps
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 7: Check if version bump needed
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Check version bump
        id: check_bump
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"

          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "needs_bump=false" >> $GITHUB_OUTPUT
            echo "No version bump needed (type: skip)"
          else
            echo "needs_bump=true" >> $GITHUB_OUTPUT
            echo "Version bump needed: $CURRENT_VERSION â†’ $NEW_VERSION"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 8: Synchronize version files
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Synchronize version files
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"

          echo "Synchronizing version to: $NEW_VERSION"
          bash .claude/lib/version/sync-version-files.sh "$NEW_VERSION"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 9: Generate CHANGELOG
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Generate CHANGELOG
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          echo "Generating CHANGELOG for version $NEW_VERSION"
          bash .claude/lib/version/generate-changelog.sh "$NEW_VERSION" "$BASE_SHA"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 10: Regenerate checksums
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Regenerate checksums
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          if [ -f .claude/lib/generate-checksums.sh ]; then
            echo "Regenerating checksums..."
            bash .claude/lib/generate-checksums.sh
          else
            echo "WARNING: generate-checksums.sh not found, skipping checksum regeneration"
          fi

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 11: Commit version changes
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Commit version changes
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.analyze.outputs.bump_type }}"

          # Add modified files
          git add .claude/.version
          git add install.sh
          git add .claude/.checksums.json
          git add README.md
          git add CHANGELOG.md

          # Commit with conventional commits format
          git commit -m "chore(release): bump version to $NEW_VERSION

Version bump: $BUMP_TYPE
Automated by GitHub Actions

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

          echo "Version changes committed"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 12: Create version tag
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Create version tag
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.analyze.outputs.bump_type }}"

          # Create annotated tag (without pushing - will push with commit)
          TAG_MESSAGE="Release v$NEW_VERSION

Bump type: $BUMP_TYPE
PR: #${{ github.event.pull_request.number }}
Automated by GitHub Actions"

          git tag -a "v$NEW_VERSION" -m "$TAG_MESSAGE"

          echo "Tag v$NEW_VERSION created"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 13: Push changes and tags
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Push changes
        if: steps.check_bump.outputs.needs_bump == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"

          # Push commit and tags
          git push origin main
          git push origin "v$NEW_VERSION"

          echo "âœ“ Version $NEW_VERSION pushed successfully"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Step 14: Summary
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Version Management Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Current version: ${{ steps.current_version.outputs.version }}"
          echo "Bump type: ${{ steps.analyze.outputs.bump_type }}"

          if [ "${{ steps.check_bump.outputs.needs_bump }}" = "true" ]; then
            echo "New version: ${{ steps.new_version.outputs.new_version }}"
            echo "Status: âœ“ Version bumped and tagged"
          else
            echo "Status: No version bump (skip)"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

#!/bin/bash
# .claude/hooks/pre-commit
# Pre-commit hook for validation system
#
# Installation:
#   cp .claude/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Bypass (not recommended):
#   git commit --no-verify

set -e

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}ğŸ” Pre-commit ê²€ì¦ ì‹¤í–‰ ì¤‘...${NC}"
echo ""

# ê²€ì¦í•  íŒŒì¼ ëª©ë¡ í™•ì¸
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# .claude ë””ë ‰í† ë¦¬ ë³€ê²½ í™•ì¸
if echo "$CHANGED_FILES" | grep -q "^\.claude/"; then
    echo -e "${BLUE}â„¹  .claude ë””ë ‰í† ë¦¬ ë³€ê²½ ê°ì§€ - ê²€ì¦ ì‹¤í–‰${NC}"

    # ë¬¸ì„œ ê²€ì¦ë§Œ ì‹¤í–‰ (ë¹ ë¥¸ í”¼ë“œë°±)
    if bash .claude/lib/validate-system.sh --docs-only --quiet > /dev/null 2>&1; then
        exit_code=0
    else
        exit_code=$?
    fi

    echo ""

    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}âœ… ë¬¸ì„œ ê²€ì¦ í†µê³¼${NC}"
        exit 0
    elif [ $exit_code -eq 2 ]; then
        echo -e "${YELLOW}âš ï¸  ê²½ê³ : ë¬¸ì„œ ì¼ê´€ì„± ë‚®ìŒ (ì»¤ë°‹ í—ˆìš©)${NC}"
        echo -e "${YELLOW}   ë³´ê³ ì„œ: .claude/cache/validation-reports/latest.md${NC}"
        echo ""
        echo -e "${BLUE}ğŸ’¡ íŒ: ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì „ì²´ ë³´ê³ ì„œ í™•ì¸:${NC}"
        echo "   cat .claude/cache/validation-reports/latest.md"
        echo ""
        exit 0
    else
        echo -e "${RED}âŒ ë¬¸ì„œ ê²€ì¦ ì‹¤íŒ¨${NC}"
        echo ""
        echo -e "${BLUE}ğŸ“„ ë³´ê³ ì„œ ìœ„ì¹˜:${NC}"
        echo "   .claude/cache/validation-reports/latest.md"
        echo ""
        echo -e "${BLUE}ğŸ” ë¬¸ì œ í™•ì¸:${NC}"

        # ë³´ê³ ì„œì—ì„œ ì£¼ìš” ì˜¤ë¥˜ ì¶”ì¶œ
        if [ -f .claude/cache/validation-reports/latest.md ]; then
            echo ""
            grep -A 3 "### ì‹¤íŒ¨í•œ ë¬¸ì„œ" .claude/cache/validation-reports/latest.md 2>/dev/null || true
        fi

        echo ""
        echo -e "${YELLOW}ğŸ’¡ íŒ:${NC}"
        echo "   1. ì „ì²´ ë³´ê³ ì„œ í™•ì¸: cat .claude/cache/validation-reports/latest.md"
        echo "   2. ê²€ì¦ ë¬´ì‹œí•˜ê³  ì»¤ë°‹: git commit --no-verify (ê¶Œì¥í•˜ì§€ ì•ŠìŒ)"
        echo "   3. ë¬¸ì„œ ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„"
        echo ""

        exit 1
    fi
else
    echo -e "${GREEN}âœ“ .claude ë””ë ‰í† ë¦¬ ë³€ê²½ ì—†ìŒ - ê²€ì¦ ê±´ë„ˆëœ€${NC}"
    exit 0
fi

name: ë¬¸ì„œ ë° ì„¤ì¹˜ ê²€ì¦

on:
  push:
    branches: [ main, develop ]
    paths:
      - '.claude/**'
      - '.github/workflows/validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '.claude/**'
  workflow_dispatch:

jobs:
  validate:
    name: ë¬¸ì„œ-ì½”ë“œ ì¼ê´€ì„± ê²€ì¦
    runs-on: ubuntu-latest

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: jq ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ì „ì²´ ê²€ì¦ ì‹¤í–‰
        id: validation
        run: |
          bash .claude/lib/validate-system.sh --quiet
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ê²€ì¦ ê²°ê³¼ ì²˜ë¦¬
        run: |
          exit_code=${{ steps.validation.outputs.exit_code }}

          if [ "$exit_code" -eq 0 ]; then
            echo "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼"
            exit 0
          elif [ "$exit_code" -eq 2 ]; then
            echo "âš ï¸ ê²½ê³ : ì¼ë¶€ ê²€ì¦ ì‹¤íŒ¨ (ì¼ê´€ì„± ì ìˆ˜ >= 70%)"
            echo "ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”"
            exit 0
          else
            echo "âŒ ê²€ì¦ ì‹¤íŒ¨"
            echo "ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”"
            exit 1
          fi

      - name: ë³´ê³ ì„œ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-report-${{ github.run_number }}
          path: |
            .claude/cache/validation-reports/latest.json
            .claude/cache/validation-reports/latest.md
          retention-days: 30

      - name: ë³´ê³ ì„œ ìš”ì•½ ì¶œë ¥
        if: always()
        run: |
          echo "### ê²€ì¦ ë³´ê³ ì„œ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f .claude/cache/validation-reports/latest.json ]; then
            echo "#### ì „ì²´ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
            status=$(jq -r '.overallStatus' .claude/cache/validation-reports/latest.json)
            score=$(jq -r '.consistencyScore' .claude/cache/validation-reports/latest.json)
            echo "- ìƒíƒœ: **$status**" >> $GITHUB_STEP_SUMMARY
            echo "- ì¼ê´€ì„± ì ìˆ˜: **$score**/100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "#### ë¬¸ì„œ ê²€ì¦" >> $GITHUB_STEP_SUMMARY
            doc_passed=$(jq -r '.documentationResults.passed' .claude/cache/validation-reports/latest.json)
            doc_total=$(jq -r '.documentationResults.total' .claude/cache/validation-reports/latest.json)
            doc_avg=$(jq -r '.documentationResults.avgConsistency' .claude/cache/validation-reports/latest.json)
            echo "- í†µê³¼: $doc_passed/$doc_total" >> $GITHUB_STEP_SUMMARY
            echo "- í‰ê·  ì¼ì¹˜ìœ¨: $doc_avg%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "#### ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦" >> $GITHUB_STEP_SUMMARY
            mig_passed=$(jq -r '.migrationResults.passed' .claude/cache/validation-reports/latest.json)
            mig_total=$(jq -r '.migrationResults.total' .claude/cache/validation-reports/latest.json)
            echo "- í†µê³¼: $mig_passed/$mig_total ì‹œë‚˜ë¦¬ì˜¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "#### êµì°¨ ì°¸ì¡° ê²€ì¦" >> $GITHUB_STEP_SUMMARY
            ref_valid=$(jq -r '.crossReferenceResults.validLinks' .claude/cache/validation-reports/latest.json)
            ref_total=$(jq -r '.crossReferenceResults.totalLinks' .claude/cache/validation-reports/latest.json)
            ref_validity=$(jq -r '.crossReferenceResults.validity' .claude/cache/validation-reports/latest.json)
            echo "- ìœ íš¨í•œ ë§í¬: $ref_valid/$ref_total" >> $GITHUB_STEP_SUMMARY
            echo "- ìœ íš¨ìœ¨: $ref_validity%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "ðŸ“„ [ì „ì²´ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ](../artifacts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ë³´ê³ ì„œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi

  validate-individual:
    name: ê°œë³„ ê²€ì¦ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module:
          - docs-only
          - migration-only
          - crossref-only

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: jq ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ${{ matrix.module }} ê²€ì¦ ì‹¤í–‰
        run: |
          bash .claude/lib/validate-system.sh --${{ matrix.module }} --quiet || true

      - name: ë³´ê³ ì„œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: validation-${{ matrix.module }}-${{ github.run_number }}
          path: .claude/cache/validation-reports/latest.*
          retention-days: 7

  test-suite:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: ë¬¸ì„œ ê²€ì¦ í…ŒìŠ¤íŠ¸
        run: bash .claude/lib/__tests__/test-validate-documentation.sh

      - name: ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ í…ŒìŠ¤íŠ¸
        run: bash .claude/lib/__tests__/test-validate-migration.sh

      - name: êµì°¨ ì°¸ì¡° ê²€ì¦ í…ŒìŠ¤íŠ¸
        run: bash .claude/lib/__tests__/test-validate-crossref.sh

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… 60ê°œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ë¬¸ì„œ ê²€ì¦: 22ê°œ í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦: 23ê°œ í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- êµì°¨ ì°¸ì¡° ê²€ì¦: 15ê°œ í…ŒìŠ¤íŠ¸" >> $GITHUB_STEP_SUMMARY
